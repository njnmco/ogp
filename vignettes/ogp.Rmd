---
title: "OGP 2024 Analysis Draft 1"
author: "Neal Fultz <<neal@njnm.co>>"
date: "12/13/2024"
output: html_vignette
vignette: >
  %\VignetteIndexEntry{OGP 2020 Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
library(ogp)

knitr::opts_chunk$set(echo=FALSE)

if(! "Current.Awards" %in% colnames(allocations)) {
  allocations <- cbind(
    allocations,
    Current = Award(allocations$BudgetSize, OGP.2020_forward, allocations$ScorePercent, Year = allocations$Year, 
                    TotalBudget = c('2122'=4.5e6, '2223'=4.5e6, '2324'=4.5e6, '2425'=5.6e6 ))
  )
}

```


## Executive Summary

LA County provides $5m+ dollars in support to arts nonprofits each year through it's Organizational Grant 
Program, run by the Department of Arts and Culture. This program is unique in that it provides funds for
nonprofits for access, capacity, infrastructure and growth, which are typically out-of-scope for other grants. 

The Department of Arts and Culture computes each organization's award using a formula that
accounts for the organization's size, its score by a review panel, and the total amount of funds available.
This formula was last calibrated in 2020. Since then, factors including growth in applications
and inflation have decreased the power of the grants, but LA County has increased the total 
budget to compensate.

Here, we develop a methodology for recalibrating the formula given a set of constraints, and investigate 
several initial scenarios to determine which is best to move forward with:

* Increase Budget +$1.1m + recalibrate
* Increase Budget +$1.1m + increase brackets by inflation + recalibrate
* Increase Budget +$1.1m + increase Awards by inflation + recalibrate
* Increase Budget +$1.1m + increase brackets and rates by inflation + recalibrate
* Increase Budget +$1.1m + Drop OGP3 bracket + recalibrate
* Increase Budget +$1.1m + recalibrate + 3% cut
* Increase Budget +$1.1m + recalibrate + 5% cut
* Increase Budget +$1.1m + recalibrate + 8% cut
* Reduce Max Award to \$15M => \$200k
* Reduce Max Award to \$15M => \$150k



## Guiding Principles

The original project outlined several key goals in developing the funding formula. (From: https://www.lacountyarts.org/funding/organizational-grant-program/ogp-grantseekers/apply/ogp-grantseekers-calculator-explained )

```
> Working with a professional statistician, the following principles were used to guide the formula creation in 2013:
> 
> The solution should eliminate any discontinuous penalties for growth
> The solution should continue to allow smaller organizations to request and receive a greater proportion of their overall budget than the larger organizations
> The solution should minimize the number of contracts whose maximum grant allocation shifts up or down by more than 25% of the 2013/2014 levels
> The solution should take particular care with the smaller contracts in the OGP I and OGP II categories, for whom small changes in grant allocations create significant difficulties
> The solution could be in the form of a calculator on the Arts and Culture website
> The solution need not take into account the current OGP categories
```

This 2025 update takes the following modifications to the guidelines:

  * Current formula categories should not change "too much" (TBD)
    * Number of categories
    * Locations of cut-points between categories
    * Slopes
  * Shifts of < 5% in awards are desirable if possible
    * At individual level
    * At District / City, Discipline, OGP Budget Category / Size, and Project Category / Goal 
    
Secondary goals:  

  * Adjust for changes in utilization
  * Adjust for inflation
  * Subject to the above constraints
  
## Award Methodology

An applicants' award is calculated in several steps:

  1. Max Request = f(Applicant Budget) <br/>
    where f is a piecewise linear function, with different slopes per group, similar to tax brackets.
  
  2. Score is determined by a panel of reviewers, from 0-100%, based on a set of criterion and expert judgment. If
  a request scores high enough, it moves on to the next steps.
    
  3. Scored Request = Score * Max Request

  4. p = County Funds  / Sum(Scored Requests) <br/>
     p is the percent of requested dollars that the county can fund in a given year. 1/p can be 
     interpreted as the amount the program is "over-subscribed."
     
  5. Final (Actual) Award = p * Scored Request
  
### Notes

Because of steps 4 and 5, where the awards are scaled down to the available County Funds for a year,
each organization's award is based not only upon its budget and score, but also upon the total demand in the 
county. Over time, the number and size of applicants has grown much faster than County Funding, 
resulting in p decreasing from near 100% to less than 50%. 


## Data Dimensions

Historical awards are published on the OGP website, which we can analyze to gain some insight into 
the current trends. Because the OGP program is a two-year award, we have aggregated the 2023-2024 and
2024-2025 cohorts.

Each grantee is categorized in several ways:

  * Location in Los Angeles County
    * City
    * District
  * Discipline
  * Project Category
  * Size of Organization
    * OGP Budget Category (per guidelines)
    * Formula Category

We present summary tables of the applicant pool, aggregated by each of these dimensions, for reference. ^[All tables
are recalculated from the source data, and may be rounded slightly differently.]


### Location

```{r CityTbl}
ogp_summary_table(allocations, City, "2023/4 + 2024/5 OGP Budget By City", Year = c('2324', '2425'))
```

```{r}
ogp_summary_table(allocations, District, "2023/4 + 2024/5 OGP Budget By District of Most Activity", Year = c("2324","2425")) %>%
  arrange(District)

```

## Discipline

```{r}
ogp_summary_table(allocations, Discipline, "2023/4 + 2024/5 OGP Budget By Discipline", Year = c("2324","2425")) |>
  arrange(Discipline)
```

## Project Objective

Sustainability
: Provides support for existing artistic and/or administrative projects that help to sustain the mission and goals of arts organizations.
  
Organizational Capacity
: Provides support for new projects that increase the organizational capacity and infrastructure of arts organizations.
  
Artistic Capacity
: Provides support for new projects that increase the artistic capacity of arts organizations.
  
Accessibility
: Provides support for new or existing projects that provide public access to arts activities and programs.


```{r}
ogp_summary_table(allocations, Objective, "2023/4 + 2024/5 OGP Budget By Objective", Year = c("2324","2425")) |>
  arrange(Objective)
```


### Formula Category

In 2013, the formula introduced several categories based on applicant budget size:

  * <100k
  * 100k - 1.5M
  * 1.5M - 40M
  * 40M+
  
These categories were chosen with domain knowledge, roughly corresponding to S, M, L and XL non-profits. The 2013 formula
also included two features worth noting: the XL category was awarded a flat amount of $300k, and the S category had a minimum
award of $7500 (conceptually an organization with only $1 of budget could qualify). 

In 2020, the funding formula was further modified, but these original categories are 
still useful for describing and reporting the data.
  

```{r }
ogp_summary_table(allocations, OGPCat, "2023/4 + 2024/5 OGP Budget By Formula Category", Year=c("2324","2425")) %>% 
  arrange(OGPCat) %>% rename(`Formula Category`=OGPCat)
```

## Recalibration Methodology

The scoring and County Funds process is outside the control and scope of this project, so we will focus
on finding a new Max Request formula that matches closely the final awards that were actually awarded.
This newly calibrated formula must obey a set of constraints, chiefly that no group of the above
categories (City, District, Discipline, Funding Category) should decrease in total funds by more than 5%.
5% was initially chosen by domain knowledge as an estimate of the 2-year change in the County Funding rate,
which incorporates the typical growth among renewals and the typical number of new applicants,
although in the immediate years following the 2020 COVID19 Pandemic, it was flatter than expected.

We can explore alternative groups and find new slopes using Quadratic Programming. Quadratic
Programming will minimize the (squared) distance between the new funding curve and the actual awards,
subject to a set of constraints. ^[There are several free packages for QP: `quadprog`, `ipoptr` and `LowRankQP`
are all quite good, and have different sets of features. We used `quadprog` this time]. Care must be taken with
scaling awards, because the range (max - min) of budgets is nearly $100M dollars; this can and does 
cause precision issues in the software.

Because `p << .95`, all the actual data points are below the top of the constraints, and so the constraints
inform the solution heavily.  The squared loss function above implies that the high budget organizations
will be pulled the most towards the actual awards, while the smaller ones will be less affected. To the extent
that a small non-profit is more sensitive to decreases of $1000 than a very large one, this is desirable.
It also means that all scenarios look very similar for the largest categories and more different at the low end.

We can also specify constraints at the low end to create several scenarios, and explore their impact on the
final awards.




## Scenarios

```{r scenarios, results='hide'}

####
# * Increase Budget +$1.1m + recalibrate
# * Increase Budget +$1.1m + increase brackets by inflation + recalibrate
# * Increase Budget +$1.1m + increase rates by inflation + recalibrate
# * Increase Budget +$1.1m + increase brackets and rates by inflation + recalibrate
# * Increase Budget +$1.1m + Drop OGP3 bracket + recalibrate


scenario.allocations <- allocations %>% 
  filter(Year %in% c("2324", "2425"))

# Scenario1 - increase budget -nb this can't be implemented as extra constraint :(

scenario1.allocations <-cbind(
  scenario.allocations, 
  scenario1 = with(scenario.allocations, 
                     Award(BudgetSize, OGP.2020_forward, ScorePercent, TotalBudget=4.5e6 + 1.1e6, Year = Year))
)

categories <-   c(0, 7500, 100000, 1500000, 40000000)



scenario1.constraints <- matrix(ncol=5+1, byrow = TRUE, data=c(
  1,     0,     0,    0,    0,    1 #100% match
))

scenario1.ineq <- matrix(ncol=5+1, byrow = TRUE, data=c(
  1,    -1,     0,    0,    0,    0, 
  0,     1,    -1,    0,    0,    0, 
  0,     0,     1,   -1,    0,    0, 
  0,     0,     0,    1,   -1,    0, 
  0,     0,     0,    0,    1,    0
))


scenario1.a <- scenario2(data = scenario1.allocations,
                      B = "BudgetSize",
                      Y = "scenario1.Final",
                      Y_low = "Current.Awards",
                      mod=list(extra_eq=scenario1.constraints, extra_inq=scenario1.ineq),
                      categories = categories); .Last.value

scenario1.a <- c(1, 0.2995, 0.0387, 0.0035, 2e-04) *c(1,1,1,1,0)

cbind(categories, scenario1.a, basis(categories, categories) %*% scenario1.a, OGP.2020(categories))

### Scenario2 - shift brackets

# Consumer Price Index for All Urban Consumers (CPI-U)
# 
# Series Id:	CUURS49ASA0
# Not Seasonally Adjusted
# Series Title:	All items in Los Angeles-Long Beach-Anaheim, CA, all urban consumers, not seasonally adjusted
# Area:	Los Angeles-Long Beach-Anaheim, CA
# Item:	All items
# Base Period:	1982-84=100
# Using Half1

CPI_2020 <- 277.303
CPI_2024 <- 330.571

#round(categories *  CPI_2024 / CPI_2020, -3); dput(.Last.value)
categories_infl <- c(0, 9000, 119000, 1788000, 47684000)


scenario2.a <- scenario2(data = scenario1.allocations,
                      B = "BudgetSize",
                      Y = "scenario1.Final",
                      Y_low = "Current.Awards",
                      mod=list(extra_eq=scenario1.constraints),
                      categories = categories_infl); .Last.value

scenario2.a <- c(1, 0.2858, 0.0303, 0.0032, 1e-04) * c(1, 1, 1, 1, 0)


cbind(categories_infl, scenario2.a, basis(categories_infl, categories_infl) %*% scenario2.a, OGP.2020(categories_infl))


### Scenario3 Increase rates only

scenario3.a <- scenario2(data = scenario1.allocations,
                      B = "BudgetSize",
                      Y = "scenario1.Final",
                      Y_low = scenario1.allocations$Current.Awards * CPI_2024 / CPI_2020,
                      mod=list(extra_eq=scenario1.constraints, extra_inq=scenario1.ineq),
                      categories = categories); .Last.value


scenario3.a <- c(1, 0.3755, 0.046, 0.0041, 3e-04) * c(1, 1, 1, 1, 0)


cbind(categories, scenario3.a, basis(categories, categories) %*% scenario3.a, OGP.2020(categories))


# Scenario 4 / # * Increase Budget +$1.1m + increase brackets and rates by inflation + recalibrate

scenario4.a <- scenario2(data = scenario1.allocations,
                      B = "BudgetSize",
                      Y = "scenario1.Final",
                      Y_low = scenario1.allocations$Current.Awards * CPI_2024 / CPI_2020,
                      mod=list(extra_eq=scenario1.constraints),
                      categories = categories_infl); .Last.value

scenario4.a <-c(1, 0.3633, 0.0355, 0.0039, 2e-04) * c(1, 1, 1, 1, 0)

cbind(categories_infl, scenario4.a, basis(categories_infl, categories_infl) %*% scenario4.a, OGP.2020(categories_infl))

#scenario 5 / Combine OGP3 and 4

scenario5.categories <-   c(0, 17500, 100000, 1500000, 50e6)

scenario5.a <- scenario2(data = scenario1.allocations,
                      B = "BudgetSize",
                      Y = "scenario1.Final",
                      Y_low = "Current.Awards",
                      mod=list(extra_eq=scenario1.constraints),
                      categories = scenario5.categories); .Last.value

scenario5.a <- c(1, 0.2037, 0.0397, 0.0032, 1e-04) *  c(1, 1, 1, 1, 0)

cbind(scenario5.categories, scenario5.a, basis(scenario5.categories, scenario5.categories) %*% scenario5.a, OGP.2020(scenario5.categories))

# Scenario 6,7,8 - Scenario 1 under bugdet Cuts


# Scenario 9 - Clip at 15M budget => 200k req


adjustFinalCategoryToConstraint <- function(scen, limit, x0, cats) {
  loss <- function(x) abs(limit - OGP.2020_forward(x0, 
        scen - c(0,0,0, x[1],x[2]), categories = cats))
  x <- optim(c(0, scen[5]), loss, upper = scen[4:5], method = 'L-BFGS-B')$par
  scen - c(0,0,0, x)
}


scenario9.categories <-   c(0, 7500, 100000, 1500000, 15000000)



cap = 200000

scenario9.a <- scenario2(data = scenario1.allocations %>% mutate(Current.Awards=pmin(Current.Awards, cap)),
                      B = "BudgetSize",
                      Y = "scenario1.Final",
                      Y_low = "Current.Awards",
                      groups_const = c("City", "District", "Discipline"),
                      mod=list(extra_eq=scenario1.constraints),
                      categories = scenario9.categories); .Last.value

scenario9.a <- adjustFinalCategoryToConstraint(scenario9.a, cap, max(scenario9.categories), scenario9.categories)

scenario9.a <- c(1, 0.2995, 0.0385, 0.00821, 0) 

cbind(scenario9.categories, scenario9.a, basis(scenario9.categories, scenario9.categories) %*% scenario9.a, OGP.2020(scenario9.categories))

# Scenario 10 - Clip at 15M budget => 150k req

cap = 150000

scenario10.a <- scenario2(data = scenario1.allocations %>% mutate(Current.Awards=pmin(Current.Awards, cap)),
                      B = "BudgetSize",
                      Y = "scenario1.Final",
                      Y_low = "Current.Awards",
                      groups_const = c("City", "District", "Discipline"),
                      mod=list(extra_eq=scenario1.constraints),
                      categories = scenario9.categories); .Last.value

scenario10.a <- adjustFinalCategoryToConstraint(scenario10.a, cap, max(scenario9.categories), scenario9.categories); .Last.value

scenario10.a <- c(1, 0.2995, 0.0388, 0.0045, 0)

cbind(scenario9.categories, scenario10.a, basis(scenario9.categories, scenario9.categories) %*% scenario10.a, OGP.2020(scenario9.categories))


```

By applying different constraints on the micro category, and the category 1 slope, and different inflation adjustments,
we can create a set of several different solutions. 

1. Baseline
    - 4.5m for Odd cycle, 5.6m for Even cycle
1. Budget Increase
    - 5.6m for both cohorts
    - ~24% increase for Odd cycle
1. Scenario 1:
    - Increase Budget +$1.1m + recalibrate
2. Scenario 2 
    - Increase Budget +$1.1m + increase brackets by inflation + recalibrate
3. Scenario 3 
    - Increase Budget +$1.1m + increase rates by inflation + recalibrate
4. Scenario 4 
    - Increase Budget +$1.1m + increase brackets and rates by inflation + recalibrate
3. Scenario 5
    - Increase Budget +$1.1m + Drop OGP3 bracket + recalibrate
1. Scenario 6:
    - Scenario 1 + 3% cut
1. Scenario 7:
    - Scenario 1 + 5% cut
1. Scenario 8:
    - Scenario 1 + 8% cut


We can evaluate these scenarios at various budget sizes. All scenarios look very similar for the high end, but can be quite different at the small end:

```{r ScenComp}
b <- Reduce(union, c(categories, categories_infl, scenario5.categories, scenario9.categories)) |> sort() |> setdiff(0)
kable(cbind(
  Budget  = b, 
  Baseline = OGP.2020_forward(b),
  Scenario1= OGP.2020_forward(b, scenario1.a, categories),
  Scenario2= OGP.2020_forward(b, scenario2.a, categories_infl),
  Scenario3= OGP.2020_forward(b, scenario3.a, categories),
  Scenario4= OGP.2020_forward(b, scenario4.a, categories_infl),
  Scenario5= OGP.2020_forward(b, scenario4.a, scenario5.categories),
  Scenario9= OGP.2020_forward(b, scenario9.a, scenario9.categories),
  Scenario10= OGP.2020_forward(b, scenario10.a, scenario9.categories)
), digits = -2, format.args=list(big.mark=',', scientific = FALSE), caption="Max Request Amounts") %>% column_spec(1, border_right = TRUE)

```



```{r error=FALSE, warning=FALSE, fig.height=6, fig.width=8, fig.align="center", out.width="80%"}
b <- unique(c(0, b, max(allocations$BudgetSize)))
zzz <- data.frame(Budget=b, 
  Current = OGP.2020_forward(b),
  Scenario1= OGP.2020_forward(b, scenario1.a, categories),
  Scenario2= OGP.2020_forward(b, scenario2.a, categories_infl),
  Scenario3= OGP.2020_forward(b, scenario3.a, categories),
  Scenario4= OGP.2020_forward(b, scenario4.a, categories_infl),
  Scenario5= OGP.2020_forward(b, scenario4.a, scenario5.categories),
  Scenario9= OGP.2020_forward(b, scenario9.a, scenario9.categories),
  Scenario10= OGP.2020_forward(b, scenario10.a, scenario9.categories)
)

zzz_long <- melt(zzz, id.vars="Budget", variable.name="Scenario", value.name = "MaxAward")

ggplot(zzz_long) + aes(x=Budget, y=MaxAward, color=Scenario) + geom_line() +
  geom_point(aes(x=BudgetSize), data=allocations, y=0, pch='x', color='black') + 
  scale_y_continuous(name = "Max Request",  labels = scales::dollar) + 
  scale_x_continuous(name = "Budget",  labels = scales::dollar) +
  ggtitle("Max Request by Budget")

```

```{r error=FALSE, warning=FALSE, fig.height=6, fig.width=8, fig.align="center", out.width="80%"}
# ggplot(zzz_long) + aes(x=Budget, y=MaxAward, color=Scenario) + geom_line(aes(linetype=Scenario != "Current"), size=1.5) + xlim(1, 50000) + ylim(0, 30000) +
#   geom_point(aes(x=Budget_Size), data=allocations, y=0, pch='x', color='black') + guides(linetype="none") + ggtitle("OGP I Scenarios")


ggplot(zzz_long) + aes(x=Budget, y=MaxAward, color=Scenario) + 
    geom_abline(slope=1, intercept=0, linetype='dashed', alpha=.4) +
  geom_line() +
  geom_point(aes(x=BudgetSize), data=allocations, y=0, pch='x', color='black') + 
  scale_y_continuous(name="Max Request", limits = c(0,20000), labels = scales::dollar) + 
  scale_x_continuous(name="Budget", limits = c(0,20000), labels = scales::dollar) +
  ggtitle("Max Request by Budget (Smaller categories)") 
``` 



## Comparison by final awards by group
```{r all_sec_counterfactual, echo=FALSE, results=FALSE}

all_scenarios <- with(scenario.allocations, {
  Baseline = Award(BudgetSize, OGP.2020_forward, ScorePercent, Year = Year, beta=NULL, TotalBudget = c("2324"=4.5e6, "2425"=4.5e6+1.1e6))
  BudgetIncrease  = Award(BudgetSize, OGP.2020_forward, ScorePercent, Year = Year, beta=NULL, TotalBudget = 4.5e6 + 1.1e6)
  Scenario1= Award(BudgetSize, OGP.2020_forward, ScorePercent, Year = Year, beta=scenario1.a, TotalBudget = 4.5e6 + 1.1e6, categories = categories)
  Scenario2= Award(BudgetSize, OGP.2020_forward, ScorePercent, Year = Year, beta=scenario2.a, TotalBudget = 4.5e6 + 1.1e6, categories = categories_infl)
  Scenario3= Award(BudgetSize, OGP.2020_forward, ScorePercent, Year = Year, beta=scenario3.a, TotalBudget = 4.5e6 + 1.1e6, categories = categories)
  Scenario4= Award(BudgetSize, OGP.2020_forward, ScorePercent, Year = Year, beta=scenario4.a, TotalBudget = 4.5e6 + 1.1e6, categories = categories_infl)
  Scenario5= Award(BudgetSize, OGP.2020_forward, ScorePercent, Year = Year, beta=scenario5.a, TotalBudget = 4.5e6 + 1.1e6, categories = scenario5.categories)
  Scenario6= Award(BudgetSize, OGP.2020_forward, ScorePercent, Year = Year, beta=scenario1.a, TotalBudget = .97*(4.5e6 + 1.1e6), categories = categories)
  Scenario7= Award(BudgetSize, OGP.2020_forward, ScorePercent, Year = Year, beta=scenario1.a, TotalBudget = .95*(4.5e6 + 1.1e6), categories = categories)
  Scenario8= Award(BudgetSize, OGP.2020_forward, ScorePercent, Year = Year, beta=scenario1.a, TotalBudget = .92*(4.5e6 + 1.1e6), categories = categories)
  Scenario9= Award(BudgetSize, OGP.2020_forward, ScorePercent, Year = Year, beta=scenario9.a, TotalBudget = 4.5e6 + 1.1e6, categories = scenario9.categories)
  Scenario10= Award(BudgetSize, OGP.2020_forward, ScorePercent, Year = Year, beta=scenario10.a, TotalBudget = 4.5e6 + 1.1e6, categories = scenario9.categories)
  
  
  all_scenarios = cbind( scenario.allocations[c('Organization', 'Year', 'OGPCat', "District", "Discipline", "BudgetSize")],
                          Baseline = Baseline,
                          BudgetIncrease=BudgetIncrease, 
                          Scenario1=Scenario1, 
                          Scenario2=Scenario2, 
                          Scenario3=Scenario3, 
                          Scenario4=Scenario4,
                          Scenario5=Scenario5,
                          Scenario6=Scenario6,
                          Scenario7=Scenario7,
                          Scenario8=Scenario8,
                          Scenario9=Scenario9,
                          Scenario10=Scenario10
                         )
  environment()
})
  
list2env(as.list(all_scenarios), environment())

```

### Change in funding rate

We can aggregate the last two years Scored Requests to see how it impacts the funding scale `p` - as per the constraints, it increases by around 5% of .4 (eg .02).

```{r}
kable(rbind.data.frame(
data.frame(Scenario="Baseline", `Total Scored Request` = sum(Baseline$Grant100), `Total Final Award`=sum(Baseline$Final), check.names = FALSE),
data.frame(Scenario="BudgetIncrease", `Total Scored Request` = sum(BudgetIncrease$Grant100), `Total Final Award`=sum(BudgetIncrease$Final), check.names = FALSE),
data.frame(Scenario="Scenario1", `Total Scored Request` = sum(Scenario1$Grant100), `Total Final Award`=sum(Scenario1$Final), check.names = FALSE),
data.frame(Scenario="Scenario2", `Total Scored Request` = sum(Scenario2$Grant100), `Total Final Award`=sum(Scenario2$Final), check.names = FALSE),
data.frame(Scenario="Scenario3", `Total Scored Request` = sum(Scenario3$Grant100), `Total Final Award`=sum(Scenario3$Final), check.names = FALSE),
data.frame(Scenario="Scenario4", `Total Scored Request` = sum(Scenario4$Grant100), `Total Final Award`=sum(Scenario4$Final), check.names = FALSE),
data.frame(Scenario="Scenario5", `Total Scored Request` = sum(Scenario5$Grant100), `Total Final Award`=sum(Scenario5$Final), check.names = FALSE),
data.frame(Scenario="Scenario6", `Total Scored Request` = sum(Scenario6$Grant100), `Total Final Award`=sum(Scenario6$Final), check.names = FALSE), 
data.frame(Scenario="Scenario7", `Total Scored Request` = sum(Scenario7$Grant100), `Total Final Award`=sum(Scenario7$Final), check.names = FALSE),
data.frame(Scenario="Scenario8", `Total Scored Request` = sum(Scenario8$Grant100), `Total Final Award`=sum(Scenario8$Final), check.names = FALSE), 
data.frame(Scenario="Scenario9", `Total Scored Request` = sum(Scenario9$Grant100), `Total Final Award`=sum(Scenario9$Final), check.names = FALSE) ,
data.frame(Scenario="Scenario10", `Total Scored Request` = sum(Scenario10$Grant100), `Total Final Award`=sum(Scenario10$Final), check.names = FALSE) 


) %>%   mutate(p=`Total Final Award` / `Total Scored Request`) %>% 
  mutate(p=round(p,3), `Total Final Award` = NULL, `Total Scored Request` = round(`Total Scored Request`, -2)), 
               format.args=list(big.mark=',')) 
```

### Comparison by final awards by group
Additionally, we can look at the projected final awards for each group using historical data. Because each scenario was under the
same set of group constraints to not deviate from the current by more than 5%, they all look fairly similar. This is still a useful
check that the software is behaving correctly.

```{r}
do_summarize <- function(df) {
  summarize(df,
    Baseline = sum(Baseline.Final),
    BudgetIncrease = sum(BudgetIncrease.Final),
    Scenario1 = sum(Scenario1.Final),
    Scenario2 = sum(Scenario2.Final),
    Scenario3 = sum(Scenario3.Final),
    Scenario4 = sum(Scenario4.Final),
    Scenario5 = sum(Scenario5.Final),
    Scenario6 = sum(Scenario6.Final),
    Scenario7 = sum(Scenario7.Final),
    Scenario8 = sum(Scenario8.Final),
    Scenario9 = sum(Scenario9.Final),
    Scenario10 = sum(Scenario10.Final),
    
  ) 
} 

do_percent <- function(df) {
  ungroup(df) %>% 
  mutate(
    Baseline = 100* Baseline / sum(Baseline),
    BudgetIncrease = 100* BudgetIncrease / sum(BudgetIncrease),
    Scenario1 = 100* Scenario1 / sum(Scenario1),
    Scenario2 = 100* Scenario2 / sum(Scenario2),
    Scenario3 = 100* Scenario3 / sum(Scenario3),
    Scenario4 = 100* Scenario4 / sum(Scenario4),
    Scenario5 = 100* Scenario5 / sum(Scenario5),
    Scenario6 = 100* Scenario6 / sum(Scenario6),
    Scenario7 = 100* Scenario7 / sum(Scenario7),
    Scenario8 = 100* Scenario8 / sum(Scenario8),
    Scenario9 = 100* Scenario9 / sum(Scenario9),
    Scenario10 = 100* Scenario10 / sum(Scenario10),

      )

}
```



#### District

```{r scen_distr}
d1 <- all_scenarios %>% 
  group_by(District) %>% 
  do_summarize() 

  kable(d1, digits = -2, format.args=list(big.mark=','), caption="Final Award Amounts by District")
```

```{r scen_disc_distr}
d1 %>% do_percent() %>% 
    kable(digits = 2, format.args=list(big.mark=','), caption="Final Awards % by District")

```


#### Formula Category

```{r scen_ogp}
d1 <- all_scenarios %>% group_by(OGPCat) %>% 
    do_summarize()  %>% rename(`Formula Category`=OGPCat)

  kable(d1, digits = -2, format.args=list(big.mark=','), caption="Final Award Amounts by Formula Category")
```

```{r scen_disc_ogp}
d1 %>% do_percent %>% 
    kable(digits = 2, format.args=list(big.mark=','), caption="Final Awards % by Formula Category")

```


#### Discipline

```{r scen_disc}
d1 <- 
  all_scenarios %>% group_by(Discipline) %>% 
    do_summarize()

  kable(d1, digits = -2, format.args=list(big.mark=','), caption="Final Award Amounts by Discipline")
```

```{r scen_disc_perc}
d1 %>% do_percent() %>% 
    kable(digits = 2, format.args=list(big.mark=','), caption="Final Awards % by Discipline")

```

#### Largest changes in each scenario

For each scenario, we can find the 20 organizations that had the largest absolute or percent change. For scenarios with less than 40 entries, 
there was an organization that was largest in both absolute *and* percent change. Generally speaking the largest organizations have the absolute
changes while the small ones have the largest percent changes.


```{r}
all_scenarios %>% mutate(Scenario=BudgetIncrease.Final, delta=Scenario - Baseline.Final, percentChange= 100*(Scenario /Current.Final - 1)) %>% 
  arrange(-BudgetSize) %>% filter(rank(-abs(percentChange))< 20 | rank(-abs(delta))< 20 ) %>% 
  select(Organization, BudgetSize, Baseline.Final, Scenario, delta, percentChange) %>% 
  kable(digits = 2, format.args=list(big.mark=','), caption="Largest Changes in Final Awards, Budget Increase")

```


```{r}
all_scenarios %>% mutate(Scenario=Scenario1.Final, delta=Scenario - Baseline.Final, percentChange= 100*(Scenario /Current.Final - 1)) %>% 
  arrange(-BudgetSize) %>% filter(rank(-abs(percentChange))< 20 | rank(-abs(delta))< 20 ) %>% 
  select(Organization, BudgetSize, Baseline.Final, Scenario, delta, percentChange) %>% 
  kable(digits = 2, format.args=list(big.mark=','), caption="Largest Changes in Final Awards, Scenario1")

```
  
```{r}
all_scenarios %>% mutate(Scenario=Scenario2.Final, delta=Scenario - Baseline.Final, percentChange= 100*(Scenario /Current.Final - 1)) %>% 
  arrange(-BudgetSize) %>% filter(rank(-abs(percentChange))< 20 | rank(-abs(delta))< 20 ) %>% 
  select(Organization, BudgetSize, Baseline.Final, Scenario, delta, percentChange) %>% 
  kable(digits = 2, format.args=list(big.mark=','), caption="Largest Changes, Scenario2")

```  

```{r}
all_scenarios %>% mutate(Scenario=Scenario3.Final, delta=Scenario - Baseline.Final, percentChange= 100*(Scenario /Current.Final - 1)) %>% 
  arrange(-BudgetSize) %>% filter(rank(-abs(percentChange))< 20 | rank(-abs(delta))< 20 ) %>% 
  select(Organization, BudgetSize, Baseline.Final, Scenario, delta, percentChange) %>% 
  kable(digits = 2, format.args=list(big.mark=','), caption="Largest Changes, Scenario3")

```

```{r}
all_scenarios %>% mutate(Scenario=Scenario4.Final, delta=Scenario - Baseline.Final, percentChange= 100*(Scenario /Current.Final - 1)) %>% 
  arrange(-BudgetSize) %>% filter(rank(-abs(percentChange))< 20 | rank(-abs(delta))< 20 ) %>% 
  select(Organization, BudgetSize, Baseline.Final, Scenario, delta, percentChange) %>% 
  kable(digits = 2, format.args=list(big.mark=','), caption="Largest Changes, Scenario4")

```

```{r}
all_scenarios %>% mutate(Scenario=Scenario5.Final, delta=Scenario - Baseline.Final, percentChange= 100*(Scenario /Current.Final - 1)) %>% 
  arrange(-BudgetSize) %>% filter(rank(-abs(percentChange))< 20 | rank(-abs(delta))< 20 ) %>% 
  select(Organization, BudgetSize, Baseline.Final, Scenario, delta, percentChange) %>% 
  kable(digits = 2, format.args=list(big.mark=','), caption="Largest Changes, Scenario5")

```


```{r}
all_scenarios %>% mutate(Scenario=Scenario6.Final, delta=Scenario - Baseline.Final, percentChange= 100*(Scenario /Current.Final - 1)) %>% 
  arrange(-BudgetSize) %>% filter(rank(-abs(percentChange))< 20 | rank(-abs(delta))< 20 ) %>% 
  select(Organization, BudgetSize, Baseline.Final, Scenario, delta, percentChange) %>% 
  kable(digits = 2, format.args=list(big.mark=','), caption="Largest Changes, Scenario 6")

```

```{r}
all_scenarios %>% mutate(Scenario=Scenario7.Final, delta=Scenario - Baseline.Final, percentChange= 100*(Scenario /Current.Final - 1)) %>% 
  arrange(-BudgetSize) %>% filter(rank(-abs(percentChange))< 20 | rank(-abs(delta))< 20 ) %>% 
  select(Organization, BudgetSize, Baseline.Final, Scenario, delta, percentChange) %>% 
  kable(digits = 2, format.args=list(big.mark=','), caption="Largest Changes, Scenario7")

```

```{r}
#all_scenarios %>% mutate(Scenario=Scenario2.Final, delta=Scenario - Current.Final, percentChange= 100*(Scenario /Current.Final - 1)) %>% 
#  ggplot() + aes(x=percentChange) + geom_histogram()
```


```{r}
all_scenarios %>% mutate(Scenario=Scenario8.Final, delta=Scenario - Baseline.Final, percentChange= 100*(Scenario /Current.Final - 1)) %>% 
  arrange(-BudgetSize) %>% filter(rank(-abs(percentChange))< 20 | rank(-abs(delta))< 20 ) %>% 
  select(Organization, BudgetSize, Baseline.Final, Scenario, delta, percentChange) %>% 
  kable(digits = 2, format.args=list(big.mark=','), caption="Largest Changes, Scenario 8")

```

#### Total changes

We can also aggregate the changes in final reward by whether it increased or not (vs expected Budget Increase), and by how much:


```{r deltatbl}
zzz <- all_scenarios[c('Scenario1.Final','Scenario2.Final','Scenario3.Final','Scenario4.Final', 'Scenario5.Final', 'Scenario6.Final', 'Scenario7.Final', 'Scenario8.Final', 'Scenario9.Final', 'Scenario10.Final')] - all_scenarios$BudgetIncrease.Final

zzz <- data.frame(Organization=all_scenarios$Organization, OGP_Budget_Category=all_scenarios$OGPCat, zzz)


melt(zzz, c("Organization", "OGP_Budget_Category")) %>% 
  group_by(Scenario=sub(".Final", "", variable), 
           delta=ifelse(sign(value) > 0, '\\+', '\\-')
           ) %>% 
  summarise(n=n(), avg=mean(value), min=min(value), med=median(value), max=max(value)) %>% 
    kable( digits=0, caption="Types / Sizes of Changes")

```

```{r deltatbl2, echo=FALSE}

melt(zzz, c("Organization", "OGP_Budget_Category")) %>% 
  group_by(Scenario=sub(".Final", "", variable), 
           `Formula Group`=OGP_Budget_Category,
           delta=ifelse(sign(value) > 0, '\\+', '\\-')
           ) %>% 
  summarise(n=n(), avg=mean(value), min=min(value), med=median(value), max=max(value)) %>% 
  arrange(Scenario, `Formula Group`) %>% 
    kable( digits=0, caption="Types / Sizes of Changes by Formula Group",align='lccrrrrr') %>% 
    row_spec(c(6:12, 20:25, 33:38, 44:48, 53:59 ), background="lightgrey")

```
  
### Final Comments and Caveats

* All of the above scenarios can blended - if it were desired to split the difference between Scenario 1 and 3, for example,
    their coefficients can be averaged; this would still satisfy all the group constraints previously described.
    * The exception is if the categories are different. We can't blend Scenario 1 and 3, for example.
* All of the above figures are based on historical data and the assumption that it is representative of the process moving 
    forward. There are several reasons why this may not be the case:
    * The increase in the standard deduction may disincentive smaller donations, reducing organization budgets and therefore
        their max rewards.
    * The turbulence in the stock market may impact organization endowments, reducing their organization budget.
    * The Covid pandemic may mean that certain disciplines are adversely affected, especially live performances that
        can't transition to online are canceled outright. The loss in ticket sales, among other things, reduces their budget.
    * All of the above may drive new organizations to apply for grants, reducing the average award for renewals.
    * Similarly, all of the above could cause organizations to close, increasing the average award for survivors.
* Messaging around decreased awards should be handled delicately.
    * For the largest organizations, this is a small percent of their award.
    * For micro organizations, there is a clear path to higher awards:
        * Increase fundraising such that budget is greater than $15,000 / year.
    * For both categories, emphasize that higher scores are funded more, and that adopting best practices and following guidelines
        will help. The extra dollar award per point on the review phase is at least 5% higher under all scenarios.


# Appendix A: Integration with website


The original JavaScript module was found at 

https://www.lacountyarts.org/sites/all/modules/custom/lacac_calc_button/js/lacac_calc_button.js?pzw4vt

and contains more precision on the slopes than is listed on the OGP website. Since 2020, that was updated to

https://www.lacountyarts.org/sites/default/files/js/js_pa6EhFUALtJQlWo5Qj-7Gs4y5d9vTSerRl4vDyFWoVE.js line 7800

which I suspect is a build artifact from a JS bundler or similar.

It is used on the website calculator widget:

https://www.lacountyarts.org/funding/organizational-grant-program/ogp-grantseekers/ogp-grantseekers-apply

When an appropriate plan is chosen, it will be straightforward to update the slopes in that module.

## Scenario 1 Website collateral
```{r comment=NA}
s1s <- solveForBrackets(scenario1.a)
cat(to_code(s1s))
```

```{r comment=NA}
cat(to_text(s1s))
```

## Scenario 2 Website collateral
```{r comment=NA}
s2s <- solveForBrackets(scenario2.a)
cat(to_code(s2s))
```

```{r comment=NA}
cat(to_text(s2s))
```



## Scenario 3 Website collateral
```{r comment=NA}
s3s <- solveForBrackets(scenario3.a)
cat(to_code(s3s))
```

```{r comment=NA}
cat(to_text(s3s))
```


## Scenario 4 Website collateral
```{r comment=NA}
s4s <- solveForBrackets(scenario4.a)
cat(to_code(s4s))
```

```{r comment=NA}
cat(to_text(s4s))
```

## Scenario 5 Website collateral
```{r comment=NA}
s5s <- solveForBrackets(scenario5.a)
cat(to_code(s5s))
```

```{r comment=NA}
cat(to_text(s5s))
```

## Scenario 6,7,8

Same code as Scenario 1

## Scenario 9 Website collateral
```{r comment=NA}
s9s <- solveForBrackets(scenario9.a)
cat(to_code(s9s))
```

```{r comment=NA}
cat(to_text(s9s))
```

## Scenario 10 Website collateral
```{r comment=NA}
s10s <- solveForBrackets(scenario10.a)
cat(to_code(s10s))
```

```{r comment=NA}
cat(to_text(s10s))
```


# Appendix B: R Package Notes

### Installation

  1. Clone the GitHub repo
  2. Place the OGP data files (Requests excel, awards PDF) in `data/`
    a. If input formats have changed, modify the code in `data/allocations.R`
  3. Install the package using R
  4. In R, knit this vignette (`ogp.Rmd`) to regenerate all plots and tables.
  5. To recalibrate the scenarios, uncomment the appropriate lines and knit again.
  
# Appendix C: Percent Change Plots


```{r, echo=FALSE}
perc_change_plot <- function(df, categories, scenario) {
  bg <- df %>% 
    mutate(OGPCat=cut(Budget, c(0, 2e5, 1e6, 15e6, 400e6), labels = paste("OGP", 1:4))) %>% 
    mutate(top=max(PercentChange) + .1, bottom=min(PercentChange) -.1) %>% 
    group_by(OGPCat, top, bottom) %>% 
      summarise(left=min(Budget), right=max(Budget), n=length(Budget))
  
  n_c <- table(cut(df$Budget, categories%>% c(max(df$Budget)))) 
  
  cdf <- data.frame(label=sprintf("> $% 7.0f:\n %3.1f%% (%d)", categories, scenario*100, n_c), x=pmax(categories,1e3), y=bg$bottom[1])
  
  
  ggplot(df) + 
    geom_rect(aes(x=1, y=1,color=1, xmin=left,  xmax=right, ymin=bottom, ymax=top, fill=OGPCat), data=bg, alpha=.2, color=0 ) +
    geom_label(aes(x=sqrt(left*right), y=top-.05, label = paste(OGPCat, "\n", n), fill=OGPCat), data=bg, color="black")+
    aes(Budget, PercentChange, color=sign(PercentChange-1)) + 
    geom_point(data=df) + 
    geom_smooth(formula=y~x, color='cyan', se = FALSE, method='loess', linetype='dashed') + 
    geom_hline(yintercept=1, color='black', linetype='dashed') + 
    geom_hline(yintercept=5.6/4.5, color='black', linetype='dashed')  +
    geom_vline(aes(xintercept=x),data=cdf, linetype='dashed') + 
    geom_label(aes(x=x+.05,y=y, label=label, color=1), data=cdf, color='black', hjust=-.2) +
  scale_x_log10(labels=scales::label_dollar(), limits=c(1000, 4e8)) + 
  scale_y_log10(labels = scales::label_percent(), breaks=seq(.8, 1.5, .1)) +
  scale_color_continuous(guide="none") +
  scale_fill_discrete(guide='none')
}
    
```


```{r, echo=FALSE, fig.width=8, fig.height=5}
data.frame(Budget=scenario.allocations$BudgetSize, PercentChange=Scenario1$Final / Baseline$Final) %>% 
perc_change_plot(categories, scenario1.a) + 
  ggtitle("Scenario 1 Percent Change")
```

```{r, echo=FALSE, fig.width=8, fig.height=5}
data.frame(Budget=scenario.allocations$BudgetSize, PercentChange=Scenario2$Final / Baseline$Final) %>% 
perc_change_plot(categories_infl, scenario2.a) + 
  ggtitle("Scenario2 Percent Change")
```



```{r, echo=FALSE, fig.width=8, fig.height=5}
data.frame(Budget=scenario.allocations$BudgetSize, PercentChange=Scenario3$Final / Baseline$Final) %>% 
perc_change_plot(categories, scenario3.a) + 
  ggtitle("Scenario 3 Percent Change")
```



```{r, echo=FALSE, fig.width=8, fig.height=5}
data.frame(Budget=scenario.allocations$BudgetSize, PercentChange=Scenario4$Final / Baseline$Final) %>% 
perc_change_plot(categories_infl, scenario4.a) + 
  ggtitle("Scenario 4 Percent Change")
```




```{r, echo=FALSE, fig.width=8, fig.height=5}
data.frame(Budget=scenario.allocations$BudgetSize, PercentChange=Scenario5$Final / Baseline$Final) %>% 
perc_change_plot(scenario5.categories, scenario5.a) + 
  ggtitle("Scenario 5 Percent Change")
```


```{r, echo=FALSE, fig.width=8, fig.height=5}
data.frame(Budget=scenario.allocations$BudgetSize, PercentChange=Scenario6$Final / Baseline$Final) %>% 
perc_change_plot(categories, scenario1.a) + 
  ggtitle("Scenario 6 Percent Change")
```


```{r, echo=FALSE, fig.width=8, fig.height=5}
data.frame(Budget=scenario.allocations$BudgetSize, PercentChange=Scenario7$Final / Baseline$Final) %>% 
perc_change_plot(categories, scenario1.a) + 
  ggtitle("Scenario 7 Percent Change")
```



```{r, echo=FALSE, fig.width=8, fig.height=5}
data.frame(Budget=scenario.allocations$BudgetSize, PercentChange=Scenario8$Final / Baseline$Final) %>% 
perc_change_plot(categories, scenario1.a) + 
  ggtitle("Scenario 8 Percent Change")
```

```{r, echo=FALSE, fig.width=8, fig.height=5}
data.frame(Budget=scenario.allocations$BudgetSize, PercentChange=Scenario9$Final / Baseline$Final) %>% 
perc_change_plot(scenario9.categories, scenario9.a) + 
  ggtitle("Scenario 9 Percent Change")
```


```{r, echo=FALSE, fig.width=8, fig.height=5}
data.frame(Budget=scenario.allocations$BudgetSize, PercentChange=Scenario10$Final / Baseline$Final) %>% 
perc_change_plot(scenario9.categories, scenario10.a) + 
  ggtitle("Scenario 10 Percent Change")
```




